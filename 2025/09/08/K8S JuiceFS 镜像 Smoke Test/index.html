<!DOCTYPE html><html lang="zh-TW" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>K8S JuiceFS 镜像 Smoke Test | FruiteeBag</title><meta name="keywords" content="K8S,JuiceFS"><meta name="author" content="Fruitee"><meta name="copyright" content="Fruitee"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="JuiceFS 在 K8S 上的部署一般通过打包镜像的方式，这与目前 JuiceFS 在集群的部署方式有关。当前 JuiceFS 使用的是  CSI 存储卷的方式，这也是 JuiceFS 官方推荐的部署方式之一。 这里首先需要对 CSI 有一定的了解。 背景介绍CSI 介绍 CSI (Container Storage Interface) 是一个行业标准规范，它定义了一套标准的接口，让任何存储系">
<meta property="og:type" content="article">
<meta property="og:title" content="K8S JuiceFS 镜像 Smoke Test">
<meta property="og:url" content="http://fruiteepro.github.io/2025/09/08/K8S%20JuiceFS%20%E9%95%9C%E5%83%8F%20Smoke%20Test/index.html">
<meta property="og:site_name" content="FruiteeBag">
<meta property="og:description" content="JuiceFS 在 K8S 上的部署一般通过打包镜像的方式，这与目前 JuiceFS 在集群的部署方式有关。当前 JuiceFS 使用的是  CSI 存储卷的方式，这也是 JuiceFS 官方推荐的部署方式之一。 这里首先需要对 CSI 有一定的了解。 背景介绍CSI 介绍 CSI (Container Storage Interface) 是一个行业标准规范，它定义了一套标准的接口，让任何存储系">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://imagebed-1305813402.cos.ap-nanjing.myqcloud.com/images/IMG_6031.jpg">
<meta property="article:published_time" content="2025-09-08T13:39:04.000Z">
<meta property="article:modified_time" content="2025-11-13T21:12:07.906Z">
<meta property="article:author" content="Fruitee">
<meta property="article:tag" content="K8S">
<meta property="article:tag" content="JuiceFS">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://imagebed-1305813402.cos.ap-nanjing.myqcloud.com/images/IMG_6031.jpg"><link rel="shortcut icon" href="/img/favicon.JPG"><link rel="canonical" href="http://fruiteepro.github.io/2025/09/08/K8S%20JuiceFS%20%E9%95%9C%E5%83%8F%20Smoke%20Test/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查詢的內容：${query}"}},
  translate: {"defaultEncoding":1,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '複製成功',
    error: '複製錯誤',
    noSupport: '瀏覽器不支援'
  },
  relativeDate: {
    homepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '剛剛',
    min: '分鐘前',
    hour: '小時前',
    day: '天前',
    month: '個月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: Fruitee","link":"連結: ","source":"來源: FruiteeBag","info":"著作權歸作者所有。商業轉載請聯絡作者獲得授權，非商業轉載請註明出處。"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切換為繁體","cht_to_chs":"你已切換為簡體","day_to_night":"你已切換為深色模式","night_to_day":"你已切換為淺色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'K8S JuiceFS 镜像 Smoke Test',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-11-14 05:12:07'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.1.0"><link rel="alternate" href="/atom.xml" title="FruiteeBag" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://imagebed-1305813402.cos.ap-nanjing.myqcloud.com/images/avatar2.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">23</div></a><a href="/tags/"><div class="headline">標籤</div><div class="length-num">19</div></a><a href="/categories/"><div class="headline">分類</div><div class="length-num">0</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标籤</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://imagebed-1305813402.cos.ap-nanjing.myqcloud.com/images/IMG_6031.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">FruiteeBag</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜尋</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标籤</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">K8S JuiceFS 镜像 Smoke Test</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">發表於</span><time class="post-meta-date-created" datetime="2025-09-08T13:39:04.000Z" title="發表於 2025-09-08 21:39:04">2025-09-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新於</span><time class="post-meta-date-updated" datetime="2025-11-13T21:12:07.906Z" title="更新於 2025-11-14 05:12:07">2025-11-14</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字數總計:</span><span class="word-count">3.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">閱讀時長:</span><span>15分鐘</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>JuiceFS 在 K8S 上的部署一般通过打包镜像的方式，这与目前 JuiceFS 在集群的部署方式有关。当前 JuiceFS 使用的是  CSI 存储卷的方式，这也是 JuiceFS 官方推荐的部署方式之一。</p>
<p>这里首先需要对 CSI 有一定的了解。</p>
<h1 id="背景介绍"><a href="#背景介绍" class="headerlink" title="背景介绍"></a>背景介绍</h1><h2 id="CSI-介绍"><a href="#CSI-介绍" class="headerlink" title="CSI 介绍"></a>CSI 介绍</h2><blockquote>
<p>CSI (Container Storage Interface) 是一个行业标准规范，它定义了一套标准的接口，让任何存储系统（如云硬盘、本地存储、网络文件系统等）都能以统一的方式接入到容器编排系统（如 Kubernetes）中。</p>
</blockquote>
<p>CSI 最大的作用就是将存储驱动的逻辑从 K8S 的核心代码中分离出来，成为 K8S 的插件，避免每次增加存储驱动都必须重新开发 K8S。</p>
<p>CSI 通过一套基于 gRPC 的 API 规范来实现分离。一个完整的 CSI 驱动通常由两部分组成：</p>
<ol>
<li><p>Controller Plugin</p>
<ul>
<li><p>负责存储卷的“管理”操作，这些操作不依赖于任何特定的节点。例如：</p>
<ul>
<li><p><strong>创建&#x2F;删除卷 (CreateVolume &#x2F; DeleteVolume)</strong> ：当用户请求一个新的持久卷时，它会调用底层存储 API 来创建。</p>
</li>
<li><p><strong>附加&#x2F;分离卷 (ControllerPublishVolume &#x2F; ControllerUnpublishVolume)</strong> ：将云硬盘等存储卷附加到指定的虚拟机节点上。</p>
</li>
<li><p><strong>创建&#x2F;删除快照 (CreateSnapshot &#x2F; DeleteSnapshot)</strong> ：对存储卷进行快照备份。</p>
</li>
</ul>
</li>
<li><p><strong>部署方式</strong> ：通常以 <code>Deployment</code> 或 <code>StatefulSet</code> 的形式在集群中运行，只需要一个或少数几个实例。</p>
</li>
</ul>
</li>
<li><p>Node Plugin</p>
<ul>
<li><p>负责在具体的节点上执行与卷相关的“本地”操作。例如：</p>
<ul>
<li><p><strong>挂载卷 (NodePublishVolume)</strong> ：将已经附加到节点上的存储设备（如 <code>/dev/sdb</code>）挂载到 Pod 需要的目录中。</p>
</li>
<li><p><strong>卸载卷 (NodeUnpublishVolume)</strong> ：当 Pod 被销毁时，将卷从目录中卸载。</p>
</li>
<li><p><strong>格式化设备 (NodeStageVolume)</strong> ：在首次挂载前，对设备进行格式化（例如，格式化为 <code>ext4</code> 文件系统）。</p>
</li>
</ul>
</li>
<li><p><strong>部署方式</strong> ：通常以 <code>DaemonSet</code> 的形式在集群的每一个（或指定的）工作节点上都运行一个实例。</p>
</li>
</ul>
</li>
</ol>
<p>CSI 的核心优势在于：</p>
<ol>
<li><p><strong>解耦和独立发展</strong>：存储厂商可以独立于 Kubernetes 发布、更新和修复他们的驱动程序，大大加快了迭代速度。</p>
</li>
<li><p><strong>增强的稳定性和安全性</strong>：驱动代码运行在独立的 Pod 中，其崩溃不会影响 Kubernetes 核心组件。</p>
</li>
<li><p><strong>易于扩展</strong>：任何存储厂商只要遵循 CSI 规范，就可以轻松编写自己的驱动，并被 Kubernetes 使用。</p>
</li>
<li><p><strong>功能标准化</strong>：CSI 不仅支持基本的挂载，还标准化了快照、卷克隆、卷扩容、拓扑感知（将 Pod 调度到离存储更近的节点）等高级功能。</p>
</li>
</ol>
<p>更多 CSI 细节和相关信息可以参考 <a target="_blank" rel="noopener" href="https://github.com/container-storage-interface/spec/blob/master/spec.md">https://github.com/container-storage-interface/spec/blob/master/spec.md</a></p>
<h2 id="JuiceFS-CSI-Driver"><a href="#JuiceFS-CSI-Driver" class="headerlink" title="JuiceFS CSI Driver"></a>JuiceFS CSI Driver</h2><p>官方文档链接：<a target="_blank" rel="noopener" href="https://juicefs.com/docs/zh/csi/introduction/">https://juicefs.com/docs/zh/csi/introduction/</a></p>
<p>JuiceFS 为了兼容 K8S 部署，开发了 JuiceFS CSI Dirver，用于 JuiceFS Pod 的编排调度。在 K8S 下，JuiceFS 可以用持久卷（PersistentVolume）的形式提供给 Pod 使用。</p>
<p>JuiceFS CSI 默认使用的是 Mount Pod 的形式，让 JuiceFS 客户端运行于独立的 Pod 之中，并且由 CSI Node Service 来管理 Mount Pod 的生命周期。其架构如下：</p>
<p><img src="https://imagebed-1305813402.cos.ap-nanjing.myqcloud.com/images/k8sjuicefsimage.png" alt="K8S JuiceFS"></p>
<p>更多的信息可以参考以下链接：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://arthurchiao.art/blog/k8s-juicefs-csi-workflow-zh/">图解 JuiceFS CSI 工作流：K8s 创建带 PV 的 Pod 时，背后发生了什么</a></li>
</ul>
<h1 id="JuiceFS-Mount-Pod-的-Smoke-Test"><a href="#JuiceFS-Mount-Pod-的-Smoke-Test" class="headerlink" title="JuiceFS Mount Pod 的 Smoke Test"></a>JuiceFS Mount Pod 的 Smoke Test</h1><p>在 K8S 中，Pod 的创建需要依赖相应的 yaml 文件，通过 <code>kubectl create -f smoke-pod.yaml</code> 进行创建。验证 JuiceFS 需要首先打包 JuiceFS 镜像。</p>
<h2 id="镜像构建"><a href="#镜像构建" class="headerlink" title="镜像构建"></a>镜像构建</h2><p>构筑镜像的 Dockerfile 可以参考：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> xxx/juicedata/build-base:with-tls AS builder</span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /build</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">cp</span> -r /assets/tls ./tls</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> make juicefs.linux</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> xxx/juicedata/<span class="keyword">run</span><span class="language-bash">-base:latest</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /build/juicefs /usr/local/bin/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">rm</span> -rf /bin/mount.juicefs &amp;&amp; <span class="built_in">ln</span> -s /usr/local/bin/juicefs /bin/mount.juicefs &amp;&amp; /usr/local/bin/juicefs --version</span></span><br></pre></td></tr></table></figure>

<p>随后使用 docker build 来构建镜像：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t juicefs-pod-test-image -f mount.Dockerfile .</span><br></pre></td></tr></table></figure>

<h2 id="K8S-Pod-构建"><a href="#K8S-Pod-构建" class="headerlink" title="K8S Pod 构建"></a>K8S Pod 构建</h2><p>在完成镜像的构建之后，需要编写用于 Pod 创建的 yaml 文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: smoke-juicefs-pod</span><br><span class="line">  namespace: juicefs-system</span><br><span class="line">spec:</span><br><span class="line">  terminationGracePeriodSeconds: 60  <span class="comment"># 给足时间执行preStop钩子</span></span><br><span class="line">  tolerations:  <span class="comment"># 添加容忍</span></span><br><span class="line">    - operator: <span class="string">&quot;Exists&quot;</span></span><br><span class="line">  containers:</span><br><span class="line">    - name: smoke-juicefs-pod</span><br><span class="line">      image: xxx/juicedata/mount:ce-v1.3.0</span><br><span class="line">      resources:</span><br><span class="line">        requests:</span><br><span class="line">          memory: <span class="string">&quot;10Ki&quot;</span>    <span class="comment"># 设置最小内存请求</span></span><br><span class="line">          cpu: <span class="string">&quot;1m&quot;</span>        <span class="comment"># 设置最小CPU请求(0.1核)</span></span><br><span class="line">        limits:</span><br><span class="line">          memory: <span class="string">&quot;1Gi&quot;</span>      <span class="comment"># 设置内存上限</span></span><br><span class="line">          cpu: <span class="string">&quot;1000m&quot;</span>       <span class="comment"># 设置CPU上限(1核)</span></span><br><span class="line">      <span class="built_in">command</span>:</span><br><span class="line">        - <span class="string">&quot;/bin/bash&quot;</span></span><br><span class="line">      args:</span><br><span class="line">        - <span class="string">&quot;-c&quot;</span></span><br><span class="line">        - |</span><br><span class="line">          <span class="built_in">set</span> -e</span><br><span class="line">          <span class="built_in">echo</span> <span class="string">&quot;Starting JuiceFS mount verification...&quot;</span></span><br><span class="line">          <span class="comment"># 检查挂载点是否存在</span></span><br><span class="line">          <span class="keyword">if</span> ! mountpoint -q /jfs; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;ERROR: /jfs is not mounted&quot;</span></span><br><span class="line">            <span class="built_in">exit</span> 1</span><br><span class="line">          <span class="keyword">fi</span></span><br><span class="line">          <span class="built_in">echo</span> <span class="string">&quot;JuiceFS mounted successfully at /jfs&quot;</span></span><br><span class="line">          <span class="comment"># 执行读写测试</span></span><br><span class="line">          TEST_FILE=<span class="string">&quot;/jfs/smoke-test-<span class="subst">$(date +%s)</span>.txt&quot;</span></span><br><span class="line">          <span class="built_in">echo</span> <span class="string">&quot;Testing write operations...&quot;</span></span><br><span class="line">          <span class="built_in">echo</span> <span class="string">&quot;JuiceFS smoke test - <span class="subst">$(date)</span>&quot;</span> &gt; <span class="string">&quot;<span class="variable">$TEST_FILE</span>&quot;</span></span><br><span class="line">          <span class="built_in">echo</span> <span class="string">&quot;Testing read operations...&quot;</span></span><br><span class="line">          <span class="keyword">if</span> <span class="built_in">cat</span> <span class="string">&quot;<span class="variable">$TEST_FILE</span>&quot;</span> | grep -q <span class="string">&quot;JuiceFS smoke test&quot;</span>; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;Read/Write test passed&quot;</span></span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;ERROR: Read/Write test failed&quot;</span></span><br><span class="line">            <span class="built_in">exit</span> 1</span><br><span class="line">          <span class="keyword">fi</span></span><br><span class="line">          <span class="comment"># 清理测试文件</span></span><br><span class="line">          <span class="built_in">rm</span> -f <span class="string">&quot;<span class="variable">$TEST_FILE</span>&quot;</span></span><br><span class="line">          <span class="built_in">echo</span> <span class="string">&quot;Cleanup completed&quot;</span></span><br><span class="line">          <span class="built_in">echo</span> <span class="string">&quot;All tests passed. Keeping container alive...&quot;</span></span><br><span class="line">          <span class="comment"># 保持容器运行以便观察</span></span><br><span class="line">          <span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span></span><br><span class="line">            <span class="built_in">sleep</span> 60</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;JuiceFS mount status: <span class="subst">$(mountpoint /jfs &amp;&amp; echo &#x27;OK&#x27; || echo &#x27;FAILED&#x27;)</span>&quot;</span></span><br><span class="line">          <span class="keyword">done</span></span><br><span class="line">      livenessProbe:</span><br><span class="line">        <span class="built_in">exec</span>:</span><br><span class="line">          <span class="built_in">command</span>:</span><br><span class="line">          - <span class="string">&quot;/bin/bash&quot;</span></span><br><span class="line">          - <span class="string">&quot;-c&quot;</span></span><br><span class="line">          - <span class="string">&quot;mountpoint -q /jfs &amp;&amp; echo &#x27;JuiceFS mount is healthy&#x27;&quot;</span></span><br><span class="line">        initialDelaySeconds: 30</span><br><span class="line">        periodSeconds: 60</span><br><span class="line">        timeoutSeconds: 10</span><br><span class="line">        failureThreshold: 3</span><br><span class="line">      readinessProbe:</span><br><span class="line">        <span class="built_in">exec</span>:</span><br><span class="line">          <span class="built_in">command</span>:</span><br><span class="line">          - <span class="string">&quot;/bin/bash&quot;</span></span><br><span class="line">          - <span class="string">&quot;-c&quot;</span></span><br><span class="line">          - <span class="string">&quot;mountpoint -q /jfs &amp;&amp; touch /jfs/.readiness-test &amp;&amp; rm -f /jfs/.readiness-test&quot;</span></span><br><span class="line">        initialDelaySeconds: 10</span><br><span class="line">        periodSeconds: 30</span><br><span class="line">        timeoutSeconds: 5</span><br><span class="line">        failureThreshold: 2</span><br><span class="line">      lifecycle:</span><br><span class="line">        preStop:</span><br><span class="line">          <span class="built_in">exec</span>:</span><br><span class="line">            <span class="built_in">command</span>:</span><br><span class="line">            - <span class="string">&quot;/bin/bash&quot;</span></span><br><span class="line">            - <span class="string">&quot;-c&quot;</span></span><br><span class="line">            - |</span><br><span class="line">              <span class="comment"># 输出到主进程的stdout以便在日志中看到</span></span><br><span class="line">              <span class="built_in">exec</span> 1&gt;/proc/1/fd/1 2&gt;/proc/1/fd/2</span><br><span class="line">              <span class="built_in">echo</span> <span class="string">&quot;=== [PRESTOP] Starting graceful shutdown and umount verification...&quot;</span></span><br><span class="line">              <span class="comment"># 创建测试文件验证写入功能</span></span><br><span class="line">              TEST_FILE=<span class="string">&quot;/jfs/shutdown-test-<span class="subst">$(date +%s)</span>.txt&quot;</span></span><br><span class="line">              <span class="built_in">echo</span> <span class="string">&quot;=== [PRESTOP] Pre-shutdown test - <span class="subst">$(date)</span>&quot;</span> &gt; <span class="string">&quot;<span class="variable">$TEST_FILE</span>&quot;</span> || <span class="built_in">echo</span> <span class="string">&quot;=== [PRESTOP] Warning: Cannot write to JuiceFS during shutdown&quot;</span></span><br><span class="line">              <span class="comment"># 等待一段时间确保所有写操作完成</span></span><br><span class="line">              <span class="built_in">sleep</span> 5</span><br><span class="line">              <span class="comment"># 清理测试文件</span></span><br><span class="line">              <span class="built_in">rm</span> -f <span class="string">&quot;<span class="variable">$TEST_FILE</span>&quot;</span> || <span class="built_in">echo</span> <span class="string">&quot;=== [PRESTOP] Warning: Cannot clean test file&quot;</span></span><br><span class="line">              <span class="comment"># 同步文件系统</span></span><br><span class="line">              <span class="built_in">sync</span></span><br><span class="line">              <span class="built_in">echo</span> <span class="string">&quot;=== [PRESTOP] Graceful shutdown preparation completed&quot;</span></span><br><span class="line">              <span class="built_in">echo</span> <span class="string">&quot;=== [PRESTOP] Note: Actual umount will be handled by Kubernetes/CSI driver&quot;</span></span><br><span class="line">      volumeMounts:</span><br><span class="line">      - mountPath: /etc/updatedb.conf</span><br><span class="line">        name: updatedb-config</span><br><span class="line">        readOnly: <span class="literal">true</span></span><br><span class="line">        subPath: updatedb.conf</span><br><span class="line">      - mountPath: /jfs</span><br><span class="line">        name: songlin-test-pvc</span><br><span class="line">  volumes:</span><br><span class="line">  - configMap:</span><br><span class="line">      defaultMode: 420</span><br><span class="line">      name: updatedb-config</span><br><span class="line">    name: updatedb-config</span><br><span class="line">  - name: songlin-test-pvc</span><br><span class="line">    persistentVolumeClaim:</span><br><span class="line">      claimName: songlin-test-pvc</span><br></pre></td></tr></table></figure>

<p>这个 yaml 文件用于测试 APP 能否正常启动，JuiceFS 能否在其中正常挂载和读写，以及 APP 能否被正常回收。</p>
<p>然后可以在 K8S 中执行指令创建 Pod：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f smoke-pod.yaml</span><br></pre></td></tr></table></figure>

<p>完成 Pod 的创建之后，可以观察到这个 Pod 已经被创建。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">kubectl get pod smoke-juicefs-pod -n juicefs-system -o wide</span></span><br><span class="line">NAME                READY   STATUS    RESTARTS   AGE    IP             NODE </span><br><span class="line">smoke-juicefs-pod   1/1     Running   0          18m    10.120.51.223  svr28176de740</span><br></pre></td></tr></table></figure>

<h2 id="查看-Pod-logs"><a href="#查看-Pod-logs" class="headerlink" title="查看 Pod logs"></a>查看 Pod logs</h2><p>我们创建 Pod 之后立即在另一个命令行中执行命令 <code> kubectl logs smoke-juicefs-pod -n juicefs-sysstem --follow</code>，然后可以观察 Pod 的 logs 输出。</p>
<p>为了观察到正常删除回收的 logs，我们可以在看到 logs 打印出 OK 之后，执行命令 <code>kubectl delete pod smoke-juicefs-pod -n juicefs-system</code> 删除这个 pod，可以继续观察 logs：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">kubectl logs smoke-juicefs-pod -n juicefs-sysstem --follow</span></span><br><span class="line">Starting JuiceFS mount verification...</span><br><span class="line">JuiceFS mounted successfully at /jfs</span><br><span class="line">Testing write operations...</span><br><span class="line">Testing read operations...</span><br><span class="line">Read/Write test passed</span><br><span class="line">Cleanup completed</span><br><span class="line">All tests passed. Keeping container alive...</span><br><span class="line">JuiceFS mount status: /jfs is a mountpoint</span><br><span class="line">OK</span><br><span class="line">[PRESTOP] Starting graceful shutdown and umount verification...</span><br><span class="line">[PRESTOP] Graceful shutdown preparation completed</span><br><span class="line">[PRESTOP] Note: Actual umount will be handled by Kubernetes/CSI driver</span><br><span class="line">JuiceFS mount status: /jfs is a mountpoint</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<p>此时似乎已经完成了验证，但其实并没有。回顾一下我们前文提到过的 JuiceFS CSI Driver，提到过一句话：</p>
<blockquote>
<p>JuiceFS CSI 默认使用的是 Mount Pod 的形式，让 JuiceFS 客户端运行于独立的 Pod 之中，并且由 CSI Node Service 来管理 Mount Pod 的生命周期。</p>
</blockquote>
<p>如果去检查 APP Pod ，我们确实可以看到 JuiceFS 的版本号与我们构建的一致，但这个 JuiceFS 并没有被使用。APP 真正使用的 JuiceFS 客户端其实是在与 APP Pod 绑定的 Mount Pod 中，我们可以称这个 Pod 为 Client Pod。在 <a target="_blank" rel="noopener" href="https://arthurchiao.art/blog/k8s-juicefs-csi-workflow-zh/">图解 JuiceFS CSI 工作流：K8s 创建带 PV 的 Pod 时，背后发生了什么</a> 的一张图可以很好地解释到底发生了什么。</p>
<p><img src="https://imagebed-1305813402.cos.ap-nanjing.myqcloud.com/images/k8sjuicefsimage-1.png" alt="Client Pod"></p>
<p>可以看到，APP Pod 其实并不会直接读写 volume，而是通过 FUSE 把读写命令发送到 Client Pod 上，Client Pod 对文件执行读写，将结果返回给 APP Pod。</p>
<p>因此，在 APP Pod 的 logs 虽然已经打印了正确的输出，但此时使用的依然是过去的 JuiceFS，并不能说明我们编译并且构建的 JuiceFS 新版本的客户端是正常的。</p>
<h2 id="修改-Configmap"><a href="#修改-Configmap" class="headerlink" title="修改 Configmap"></a>修改 Configmap</h2><p>想测试 JuiceFS 需要让 Client Pod 中的镜像使用我们构建的版本，需要修改 Configmap 的 ceMountImage。这个参数决定了 CSI 使用什么版本的镜像构建 Client Pod，也就是我们创建的真正的 Mount Pod。</p>
<p>可以查看一下当前的 Comfigmap：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">kubectl get cm -n juicefs-system</span></span><br><span class="line">NAME                                   DATA   AGE</span><br><span class="line">istio-ca-root-cert                     1      3y194d</span><br><span class="line">juicefs-csi-driver-config              1      388d</span><br><span class="line">juicefs-csi-driver-config-km94mfbt82   1      407d</span><br><span class="line">kube-root-ca.crt                       1      526d</span><br><span class="line">mount.juicefs.com                      0      407d</span><br><span class="line">updatedb-config                        1      134d</span><br></pre></td></tr></table></figure>

<p>我们需要修改的是 <code>juicefs-csi-driver-config</code> 这个 Comfigmap：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">&gt;</span> kubectl <span class="keyword">get</span> cm juicefs<span class="operator">-</span>csi<span class="operator">-</span>driver<span class="operator">-</span>config <span class="operator">-</span>n juicefs<span class="operator">-</span><span class="keyword">system</span> <span class="operator">-</span>o yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  config.yaml: &quot;enableNodeSelector: true\nmountPodPatch:\n  - ceMountImage: juicedata/mount:ce-v1.2.0\n</span><br><span class="line">    \   hostNetwork: false\n    annotations:\n       juicefs-clean-cache: true\n       cluster-autoscaler.kubernetes.io/safe-to-evict:</span><br><span class="line">    true\n    resources:\n      requests:\n        cpu: 10m\n        memory: 16Mi\n</span><br><span class="line">    \     limits:\n        cpu: 10000m\n        memory: 10240Mi\n    mountOptions:\n</span><br><span class="line">    \   - cache-size=10G\n    - cache-dir=/var/lib/k8s/jfsCache\n    env:\n    - name:</span><br><span class="line">    BEACON_METRIC_TAG_BU\n      value: SYS\n    - name: BEACON_METRIC_ENDPOINT_PROMETHEUS_BEACON\n</span><br><span class="line">    \     value: http://:9567/metrics\n    - name: BEACON_METRIC_ENDPOINT_IP\n      valueFrom:\n</span><br><span class="line">    \       fieldRef:\n          apiVersion: v1\n          fieldPath: status.podIP\n</span><br><span class="line">    \   - name: CDOS_POD_IP\n      valueFrom:\n        fieldRef:\n          apiVersion:</span><br><span class="line">    v1\n          fieldPath: status.podIP\n    - name: CDOS_POD_NAME\n      valueFrom:\n</span><br><span class="line">    \       fieldRef:\n          apiVersion: v1\n          fieldPath: metadata.name\n</span><br><span class="line">    \   - name: CDOS_POD_NS\n      valueFrom:\n        fieldRef:\n          apiVersion:</span><br><span class="line">    v1\n          fieldPath: metadata.namespace\n  - pvcSelector:\n      matchLabels:\n</span><br><span class="line">    \       juicefs-performance-mode: seqread\n    mountOptions:\n      - cache-size=0G\n</span><br><span class="line">    \     - buffer-size=2G\n      - max-readahead=512M\n    resources:\n      requests:\n</span><br><span class="line">    \       cpu: 10m\n        memory: 16Mi\n      limits:\n        cpu: 10000m\n        memory:</span><br><span class="line">    10240Mi\n  - pvcSelector:\n      matchLabels:\n        juicefs-performance-mode:</span><br><span class="line">    work-dir\n    mountOptions:\n      - cache-size=20G\n      - buffer-size=2G\n</span><br><span class="line">    \     - cache-partial-only=true\n      - cache-dir=/var/lib/k8s/jfsCache\n      -</span><br><span class="line">    entry-cache=300\n      - attr-cache=300\n      - open-cache=300\n      - writeback=true\n</span><br><span class="line">    \     - max-uploads=100\n      - free-space-ratio=0.1 \n    annotations:\n      juicefs-delete-delay:</span><br><span class="line">    30m\n      juicefs-clean-cache: true&quot;</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    kubectl.kubernetes.io<span class="operator">/</span><span class="keyword">last</span><span class="operator">-</span>applied<span class="operator">-</span>configuration: <span class="operator">|</span></span><br><span class="line">      &#123;&quot;apiVersion&quot;:&quot;v1&quot;,&quot;data&quot;:&#123;&quot;config.yaml&quot;:&quot;enableNodeSelector: true\nmountPodPatch:\n  - ceMountImage: juicedata/mount:ce-v1.3.0\n    hostNetwork: false\n    annotations:\n       juicefs-clean-cache: true\n       cluster-autoscaler.kubernetes.io/safe-to-evict: true\n    resources:\n      requests:\n        cpu: 10m\n        memory: 16Mi\n      limits:\n        cpu: 10000m\n        memory: 10240Mi\n    mountOptions:\n    - cache-size=10G\n    - cache-dir=/var/lib/k8s/jfsCache\n    env:\n    - name: BEACON_METRIC_TAG_BU\n      value: SYS\n    - name: BEACON_METRIC_ENDPOINT_PROMETHEUS_BEACON\n      value: http://:9567/metrics\n    - name: BEACON_METRIC_ENDPOINT_IP\n      valueFrom:\n        fieldRef:\n          apiVersion: v1\n          fieldPath: status.podIP\n    - name: CDOS_POD_IP\n      valueFrom:\n        fieldRef:\n          apiVersion: v1\n          fieldPath: status.podIP\n    - name: CDOS_POD_NAME\n      valueFrom:\n        fieldRef:\n          apiVersion: v1\n          fieldPath: metadata.name\n    - name: CDOS_POD_NS\n      valueFrom:\n        fieldRef:\n          apiVersion: v1\n          fieldPath: metadata.namespace\n  - pvcSelector:\n      matchLabels:\n        juicefs-performance-mode: seqread\n    mountOptions:\n      - cache-size=0G\n      - buffer-size=2G\n      - max-readahead=512M\n    resources:\n      requests:\n        cpu: 10m\n        memory: 16Mi\n      limits:\n        cpu: 10000m\n        memory: 10240Mi\n  - pvcSelector:\n      matchLabels:\n        juicefs-performance-mode: work-dir\n    mountOptions:\n      - cache-size=20G\n      - buffer-size=2G\n      - cache-partial-only=true\n      - cache-dir=/var/lib/k8s/jfsCache\n      - entry-cache=300\n      - attr-cache=300\n      - open-cache=300\n      - writeback=true\n      - max-uploads=100\n      - free-space-ratio=0.1 \n    annotations:\n      juicefs-delete-delay: 30m\n      juicefs-clean-cache: true&quot;&#125;,&quot;kind&quot;:&quot;ConfigMap&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;name&quot;:&quot;juicefs-csi-driver-config&quot;,&quot;namespace&quot;:&quot;juicefs-system&quot;&#125;&#125;</span><br><span class="line">  creationTimestamp: &quot;2024-08-13T03:23:17Z&quot;</span><br><span class="line">  name: juicefs<span class="operator">-</span>csi<span class="operator">-</span>driver<span class="operator">-</span>config</span><br><span class="line">  namespace: juicefs<span class="operator">-</span><span class="keyword">system</span></span><br><span class="line">  resourceVersion: &quot;16911116973&quot;</span><br><span class="line">  uid: <span class="number">733</span>a1bbe<span class="number">-7531</span><span class="number">-4</span>f21<span class="operator">-</span>bf40<span class="number">-7885</span>a1dee072</span><br></pre></td></tr></table></figure>

<p>可以看到这里有 ceMountImage 这个参数。将后面的 Image 换成我们构建好的。</p>
<h2 id="最终测试"><a href="#最终测试" class="headerlink" title="最终测试"></a>最终测试</h2><p>然后，将我们之前创建的 Somke Pod 删除，重新构建。继续观察一下 Pod 的 logs。如果我们编译的 JuiceFS 没有问题，应该和上面的 logs 一样。</p>
<p>我们继续验证一下，此时 Mount Pod 的 Image 版本已经是新构建的。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">kubectl get pod_smoke-juicefs-pod -n juicefs-system -o jsconpath=<span class="string">&#x27;&#123;.spec.nodeName&#125;&#x27;</span></span></span><br><span class="line"><span class="meta prompt_">svr28176de740%</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"></span><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">kubectl get pods -n juicefs-system -l app.kubernetes.i/name=juicefs-mount</span></span><br><span class="line">NAME                                                        READY   STATUS      RESTARTS   AGE</span><br><span class="line">juicefs-svr17175hp360-pv-juicefs-fat-infer-ai-model-artifacts-vetuuz      1/1     Running     0      12d</span><br><span class="line">juicefs-svr17475in5112-pv-juicefs-fat-infer-ai-model-artifacts-bellrx     1/1     Running     0      5d1h</span><br><span class="line">juicefs-svr25209de740-pv-juicefs-fat-infer-ai-modelartifacts-xgfgd        1/1     Running     0      25d</span><br><span class="line">juicefs-svr25209de740-pv-juicefs-uat-infer-ai-model-artifacts-dbuthw      1/1     Running     0      35d</span><br><span class="line">juicefs-svr28176de740-pv-juicefs-fat-infer-ai-model-artifacts-sufihu      1/1     Running     0      42d</span><br><span class="line">juicefs-svr28176de740-songlin-test-pv-wslvif                              1/1     Running     0      6m20s</span><br><span class="line">juicefs-svr28176de740-songlin-test-pv-yorllp                              1/1     Running     0      118m</span><br><span class="line">juicefs-svr30185hw1288-pv-juicefs-fat-infer-ai-model-artifacts-pnnyuk     1/1     Running     0      56m</span><br><span class="line">juicefs-svr30186hw1288-pv-juicefs-fat-infer-ai-model-artifacts-vjblfv     1/1     Running     0      28d</span><br><span class="line">juicefs-svr30393in5212-pv-juicefs-fat-infer-ai-model-artifacts-rqbryg     1/1     Running     0      42d</span><br><span class="line">juicefs-svr30987hc4900-pv-juicefs-fat-infer-ai-model-artifacts-vaohdo     1/1     Running     0      40d</span><br><span class="line">juicefs-svr8174hp360-pv-juicefs-fat-infer-ai-model-artifacts-wiwsyt       1/1     Running     0      49d</span><br><span class="line">juicefs-svr9165hp360-juicefs-pv-zmctest-csi                               1/1     Running     0      532d</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">kubectl get pod juicefs-svr28176de740-songlin-test-pv-wslvif -n juicefs-system -o wide</span></span><br><span class="line">NAME                                          READY   STATUS    RESTARTS   AGE    IP             NODE </span><br><span class="line">juicefs-svr28176de740-songlin-test-pv-wslvif  1/1     Running   0          6m27s  10.120.51.221  svr28176de740</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">kubectl get pod juicefs-svr28176de740-songlin-test-pv-wslvif -n juicefs-system -o jsonpath=<span class="string">&#x27;&#123;.spec.containers[*].image&#125;&#x27;</span></span></span><br><span class="line">juicedata/mount:ce-v1.3.0%</span><br></pre></td></tr></table></figure>

<p>可以看到，此时 APP Pod 对应的 Mount Pod 的镜像版本已经是最新版本。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://fruiteepro.github.io">Fruitee</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章連結: </span><span class="post-copyright-info"><a href="http://fruiteepro.github.io/2025/09/08/K8S%20JuiceFS%20%E9%95%9C%E5%83%8F%20Smoke%20Test/">http://fruiteepro.github.io/2025/09/08/K8S%20JuiceFS%20%E9%95%9C%E5%83%8F%20Smoke%20Test/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版權聲明: </span><span class="post-copyright-info">本部落格所有文章除特別聲明外，均採用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 許可協議。轉載請註明來自 <a href="http://fruiteepro.github.io" target="_blank">FruiteeBag</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/K8S/">K8S</a><a class="post-meta__tags" href="/tags/JuiceFS/">JuiceFS</a></div><div class="post_share"><div class="social-share" data-image="https://imagebed-1305813402.cos.ap-nanjing.myqcloud.com/images/IMG_6031.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/gh/overtrue/share.js@master/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2025/11/17/RPM%20%E5%8C%85%E6%9E%84%E5%BB%BA%E6%8C%87%E5%8D%97/"><img class="prev-cover" src="https://imagebed-1305813402.cos.ap-nanjing.myqcloud.com/images/IMG_5841.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">RPM 包构建指南</div></div></a></div><div class="next-post pull-right"><a href="/2025/08/13/K8S%20%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86%20RBAC/"><img class="next-cover" src="https://imagebed-1305813402.cos.ap-nanjing.myqcloud.com/images/IMG_6286.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">K8S 权限管理 RBAC</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相關推薦</span></div><div class="relatedPosts-list"><div><a href="/2025/08/13/K8S%20%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86%20RBAC/" title="K8S 权限管理 RBAC"><img class="cover" src="https://imagebed-1305813402.cos.ap-nanjing.myqcloud.com/images/IMG_6286.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-08-13</div><div class="title">K8S 权限管理 RBAC</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 評論</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://imagebed-1305813402.cos.ap-nanjing.myqcloud.com/images/avatar2.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Fruitee</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">23</div></a><a href="/tags/"><div class="headline">標籤</div><div class="length-num">19</div></a><a href="/categories/"><div class="headline">分類</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/FruiteePro"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/FruiteePro" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="https://space.bilibili.com/23938356" target="_blank" title="Bilibili"><i class="fa-brands fa-bilibili"></i></a><a class="social-icon" href="https://fruiteepro.github.io/atom.xml" target="_blank" title=""><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">欢迎给我打钱！如果你不缺钱的话～</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目錄</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%83%8C%E6%99%AF%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">背景介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#CSI-%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.1.</span> <span class="toc-text">CSI 介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JuiceFS-CSI-Driver"><span class="toc-number">1.2.</span> <span class="toc-text">JuiceFS CSI Driver</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#JuiceFS-Mount-Pod-%E7%9A%84-Smoke-Test"><span class="toc-number">2.</span> <span class="toc-text">JuiceFS Mount Pod 的 Smoke Test</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA"><span class="toc-number">2.1.</span> <span class="toc-text">镜像构建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#K8S-Pod-%E6%9E%84%E5%BB%BA"><span class="toc-number">2.2.</span> <span class="toc-text">K8S Pod 构建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B-Pod-logs"><span class="toc-number">2.3.</span> <span class="toc-text">查看 Pod logs</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9-Configmap"><span class="toc-number">2.4.</span> <span class="toc-text">修改 Configmap</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%80%E7%BB%88%E6%B5%8B%E8%AF%95"><span class="toc-number">2.5.</span> <span class="toc-text">最终测试</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/11/17/RPM%20%E5%8C%85%E6%9E%84%E5%BB%BA%E6%8C%87%E5%8D%97/" title="RPM 包构建指南"><img src="https://imagebed-1305813402.cos.ap-nanjing.myqcloud.com/images/IMG_5841.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="RPM 包构建指南"/></a><div class="content"><a class="title" href="/2025/11/17/RPM%20%E5%8C%85%E6%9E%84%E5%BB%BA%E6%8C%87%E5%8D%97/" title="RPM 包构建指南">RPM 包构建指南</a><time datetime="2025-11-17T15:46:38.000Z" title="發表於 2025-11-17 23:46:38">2025-11-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/09/08/K8S%20JuiceFS%20%E9%95%9C%E5%83%8F%20Smoke%20Test/" title="K8S JuiceFS 镜像 Smoke Test"><img src="https://imagebed-1305813402.cos.ap-nanjing.myqcloud.com/images/IMG_6031.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="K8S JuiceFS 镜像 Smoke Test"/></a><div class="content"><a class="title" href="/2025/09/08/K8S%20JuiceFS%20%E9%95%9C%E5%83%8F%20Smoke%20Test/" title="K8S JuiceFS 镜像 Smoke Test">K8S JuiceFS 镜像 Smoke Test</a><time datetime="2025-09-08T13:39:04.000Z" title="發表於 2025-09-08 21:39:04">2025-09-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/08/13/K8S%20%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86%20RBAC/" title="K8S 权限管理 RBAC"><img src="https://imagebed-1305813402.cos.ap-nanjing.myqcloud.com/images/IMG_6286.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="K8S 权限管理 RBAC"/></a><div class="content"><a class="title" href="/2025/08/13/K8S%20%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86%20RBAC/" title="K8S 权限管理 RBAC">K8S 权限管理 RBAC</a><time datetime="2025-08-13T03:00:04.000Z" title="發表於 2025-08-13 11:00:04">2025-08-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/01/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/" title="2024年终总结"><img src="https://imagebed-1305813402.cos.ap-nanjing.myqcloud.com/images/29256552c759bc4091ff9e919f3c53c6.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="2024年终总结"/></a><div class="content"><a class="title" href="/2025/01/01/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/" title="2024年终总结">2024年终总结</a><time datetime="2025-01-01T14:43:47.000Z" title="發表於 2025-01-01 22:43:47">2025-01-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/11/29/C++%E9%80%89%E6%89%8B%E7%A7%8B%E6%8B%9B%E6%80%BB%E7%BB%93/" title="C++选手秋招总结"><img src="https://imagebed-1305813402.cos.ap-nanjing.myqcloud.com/images/IMG_20240923_173335.LMxAGC(2).jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="C++选手秋招总结"/></a><div class="content"><a class="title" href="/2024/11/29/C++%E9%80%89%E6%89%8B%E7%A7%8B%E6%8B%9B%E6%80%BB%E7%BB%93/" title="C++选手秋招总结">C++选手秋招总结</a><time datetime="2024-11-29T09:55:15.000Z" title="發表於 2024-11-29 17:55:15">2024-11-29</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2025 By Fruitee</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主題 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="閱讀模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="簡繁轉換">簡</button><button id="darkmode" type="button" title="淺色和深色模式轉換"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="單欄和雙欄切換"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="設定"><i class="fas fa-cog fa-spin"></i></button><button id="translateLink" type="button" title="簡繁轉換">簡</button><button class="close" id="mobile-toc-button" type="button" title="目錄"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直達評論"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到頂部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜尋</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  資料庫載入中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜尋文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'AlNrdORWm4jUMgBVBSC9y7sN-gzGzoHsz',
      appKey: 'ycwqHUuxrHvMjQM76rmvY4vo',
      avatar: 'retro',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>